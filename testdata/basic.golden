
// FastExp is a quartic spline approximation to the Exp function, by N.N. Schraudolph
// It does not have any of the sanity checking of a standard method -- returns
// nonsense when arg is out of range.  Runs in 2.23ns vs. 6.3ns for 64bit which is faster
// than math32.Exp actually.
float FastExp(float x) {
	if (x <= -88.76731) { // this doesn't add anything and -exp is main use-case anyway
		return 0;
	}
	int i = int(12102203*x) + 127*(1<<23);
	int m = i >> 7 & 0xFFFF; // copy mantissa
	i += (((((((((((3537 * m) >> 16) + 13668) * m) >> 18) + 15817) * m) >> 14) - 80470) * m) >> 11);
	return asfloat(uint(i));
}

// NeuronFlags are bit-flags encoding relevant binary state for neurons
typedef int NeuronFlags;

// The neuron flags

// NeuronOff flag indicates that this neuron has been turned off (i.e., lesioned)
const NeuronFlags NeuronOff = 1;

// NeuronHasExt means the neuron has external input in its Ext field
const NeuronFlags NeuronHasExt = 1 << 2;

// NeuronHasTarg means the neuron has external target input in its Target field
const NeuronFlags NeuronHasTarg = 1 << 3;

// NeuronHasCmpr means the neuron has external comparison input in its Target field -- used for computing
// comparison statistics but does not drive neural activity ever
const NeuronFlags NeuronHasCmpr = 1 << 4;

// DataStruct has the test data
struct DataStruct {
	float Raw;
	float Integ;
	float Exp;
	float Pad2;
};

// ParamStruct has the test params
struct ParamStruct {
	float     Tau;
	float     Dt;
	int Option; // note: standard bool doesn't work

// IntegFmRaw computes integrated value from current raw value
	void IntegFmRaw(inout DataStruct ds, inout float modArg) {
		// note: the following are just to test basic control structures
		float newVal = this.Dt*(ds.Raw-ds.Integ) + modArg;
		if (newVal < -10 || (1 == this.Option)) {
			newVal = -10;
		}
		ds.Integ += newVal;
		ds.Exp = exp(-ds.Integ);
	}

	void AnotherMeth(inout DataStruct ds) {
		int i;
		for (i = 0; i < 10; i++) {
			ds.Integ *= 0.99;
		}
		NeuronFlags flag;
		flag &=~NeuronHasExt; // clear flag -- op doesn't exist in C
	}

};


// AnotherMeth does more computation
[[vk::binding(0, 0)]] uniform ParamStruct Params;
[[vk::binding(0, 1)]] RWStructuredBuffer<DataStruct> Data;
[numthreads(1, 1, 1)]
void main(uint3 idx : SV_DispatchThreadID) {
    Params.IntegFmRaw(Data[idx.x], Data[idx.x].Pad2);
}




